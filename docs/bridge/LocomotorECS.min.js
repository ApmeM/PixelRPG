Bridge.assembly("LocomotorECS",function($asm,globals){"use strict";Bridge.define("LocomotorECS.Component",{fields:{enabled:!1},events:{ComponentEnabled:null,ComponentDisabled:null},props:{Entity:null,Enabled:{get:function(){return this.enabled},set:function(value){this.enabled!==value&&(this.enabled=value,this.enabled?Bridge.staticEquals(this.ComponentEnabled,null)?null:this.ComponentEnabled(this):Bridge.staticEquals(this.ComponentDisabled,null)?null:this.ComponentDisabled(this))}}},ctors:{init:function(){this.enabled=!0}}});Bridge.define("LocomotorECS.ComponentList",{fields:{entity:null,components:null,componentsToAdd:null,componentIdxToRemove:null,componentIdxToDisable:null,componentIdxToEnable:null,Bits:null},ctors:{init:function(){this.components=new(System.Collections.Generic.Dictionary$2(System.Int32,LocomotorECS.Component));this.componentsToAdd=new(System.Collections.Generic.Dictionary$2(System.Int32,LocomotorECS.Component));this.componentIdxToRemove=new(System.Collections.Generic.HashSet$1(System.Int32).ctor);this.componentIdxToDisable=new(System.Collections.Generic.HashSet$1(System.Int32).ctor);this.componentIdxToEnable=new(System.Collections.Generic.HashSet$1(System.Int32).ctor);this.Bits=new LocomotorECS.Matching.BitSet.ctor},ctor:function(entity){this.$initialize();this.entity=entity}},methods:{Add:function(T){return this.Add$1(T,Bridge.createInstance(T))},Add$1:function(T,component){var idx=LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(Bridge.getType(component,T));return this.componentsToAdd.add(idx,component),component},Remove$1:function(T){var idx=LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(T);this.componentsToAdd.remove(idx);this.componentIdxToRemove.add(idx)},Remove:function(component){var idx=LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(Bridge.getType(component));this.componentsToAdd.remove(idx);this.componentIdxToRemove.add(idx)},Get:function(T,withPending){withPending===void 0&&(withPending=!0);var idx=LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(T);return this.components.containsKey(idx)?Bridge.cast(this.components.get(idx),T):withPending&&this.componentsToAdd.containsKey(idx)?Bridge.cast(this.componentsToAdd.get(idx),T):null},GetOrCreate:function(T){var comp=this.Get(T);return comp==null&&(comp=this.Add(T)),comp},CommitChanges:function(){var $t,$t1,$t2,$t3,idx,idx1,idx2,component,component1,idx3,isSomethingChanged;if(this.componentIdxToDisable.Count>0){$t=Bridge.getEnumerator(this.componentIdxToDisable);try{while($t.moveNext())idx=$t.Current,this.Bits.Set$1(idx,!1)}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}}if(this.componentIdxToEnable.Count>0){this.entity.Enabled||this.componentIdxToEnable.clear();$t1=Bridge.getEnumerator(this.componentIdxToEnable);try{while($t1.moveNext())idx1=$t1.Current,this.Bits.Set$1(idx1,!0)}finally{Bridge.is($t1,System.IDisposable)&&$t1.System$IDisposable$Dispose()}}if(this.componentIdxToRemove.Count>0){$t2=Bridge.getEnumerator(this.componentIdxToRemove);try{while($t2.moveNext())idx2=$t2.Current,this.Bits.Set$1(idx2,!1),this.components.containsKey(idx2)&&(component=this.components.get(idx2),component.Entity=null,component.removeComponentEnabled(Bridge.fn.cacheBind(this,this.ComponentEnabled)),component.removeComponentDisabled(Bridge.fn.cacheBind(this,this.ComponentDisabled)),this.components.remove(idx2))}finally{Bridge.is($t2,System.IDisposable)&&$t2.System$IDisposable$Dispose()}}if(this.componentsToAdd.count>0){$t3=Bridge.getEnumerator(this.componentsToAdd);try{while($t3.moveNext())component1=$t3.Current,idx3=LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(Bridge.getType(component1.value)),this.Bits.Set$1(idx3,this.entity.Enabled&&component1.value.Enabled),component1.value.Entity=this.entity,component1.value.addComponentEnabled(Bridge.fn.cacheBind(this,this.ComponentEnabled)),component1.value.addComponentDisabled(Bridge.fn.cacheBind(this,this.ComponentDisabled)),this.components.add(idx3,component1.value)}finally{Bridge.is($t3,System.IDisposable)&&$t3.System$IDisposable$Dispose()}}return isSomethingChanged=this.componentIdxToRemove.Count>0||this.componentsToAdd.count>0||this.componentIdxToDisable.Count>0||this.componentIdxToEnable.Count>0,this.componentIdxToRemove.clear(),this.componentsToAdd.clear(),this.componentIdxToDisable.clear(),this.componentIdxToEnable.clear(),isSomethingChanged},DisableEntity:function(){var $t,component;this.componentIdxToEnable.clear();$t=Bridge.getEnumerator(this.components);try{while($t.moveNext())component=$t.Current,this.componentIdxToDisable.add(component.key)}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}},EnableEntity:function(){var $t,component;$t=Bridge.getEnumerator(this.components);try{while($t.moveNext())component=$t.Current,component.value.Enabled&&(this.componentIdxToEnable.add(component.key),this.componentIdxToDisable.remove(component.key))}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}},ComponentDisabled:function(component){var idx=LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(Bridge.getType(component));this.componentIdxToEnable.remove(idx);this.componentIdxToDisable.add(idx)},ComponentEnabled:function(component){var idx=LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(Bridge.getType(component));this.componentIdxToDisable.remove(idx);this.componentIdxToEnable.add(idx)}}});Bridge.define("LocomotorECS.Entity",{fields:{Name:null,tag:0,enabled:!1},events:{BeforeTagChanged:null,AfterTagChanged:null},props:{Tag:{get:function(){return this.tag},set:function(value){this.tag!==value&&(Bridge.staticEquals(this.BeforeTagChanged,null)?null:this.BeforeTagChanged(this),this.tag=value,Bridge.staticEquals(this.AfterTagChanged,null)?null:this.AfterTagChanged(this))}},Enabled:{get:function(){return this.enabled},set:function(value){this.enabled!==value&&(this.enabled=value,this.enabled?this.Components.EnableEntity():this.Components.DisableEntity())}},Cache:null,Components:null},ctors:{init:function(){this.enabled=!0;this.Cache=new LocomotorECS.Entity.CacheData},ctor:function(name){name===void 0&&(name=null);this.$initialize();this.Name=name;this.Components=new LocomotorECS.ComponentList(this)}},methods:{AddComponent$1:function(T,component){return this.Components.Add$1(T,component)},AddComponent:function(T){return this.Components.Add(T)},GetComponent:function(T,withPending){return withPending===void 0&&(withPending=!0),this.Components.Get(T,withPending)},GetOrCreateComponent:function(T){return this.Components.GetOrCreate(T)},RemoveComponent$1:function(T){this.Components.Remove$1(T)},RemoveComponent:function(component){this.Components.Remove(component)}}});Bridge.define("LocomotorECS.Entity.CacheData",{$kind:"nested class",fields:{data:null},ctors:{init:function(){this.data=new(System.Collections.Generic.Dictionary$2(System.String,System.Object))}},methods:{PutData:function(T,key,value){this.data.set(key,value)},GetData:function(T,key,defaultValue){return defaultValue===void 0&&(defaultValue=Bridge.getDefaultValue(T)),this.data.containsKey(key)?Bridge.cast(Bridge.unbox(this.data.get(key),T),T):defaultValue},ReplaceData:function(T,key,value,defaultValue){defaultValue===void 0&&(defaultValue=Bridge.getDefaultValue(T));var oldData=this.GetData(T,key,defaultValue);return this.PutData(T,key,value),oldData},GetOrAddData:function(T,key,builder){if(this.data.containsKey(key))return Bridge.cast(Bridge.unbox(this.data.get(key),T),T);var value=builder();return this.data.set(key,value),value}}});Bridge.define("LocomotorECS.EntityList",{fields:{entities:null,entitiesToAdd:null,entitiesToRemove:null,entityTagsDict:null,entityNamesDict:null},events:{EntityRemoved:null,EntityAdded:null,EntityChanged:null},ctors:{init:function(){this.entities=new(System.Collections.Generic.List$1(LocomotorECS.Entity).ctor);this.entitiesToAdd=new(System.Collections.Generic.HashSet$1(LocomotorECS.Entity).ctor);this.entitiesToRemove=new(System.Collections.Generic.HashSet$1(LocomotorECS.Entity).ctor);this.entityTagsDict=new(System.Collections.Generic.Dictionary$2(System.Int32,System.Collections.Generic.List$1(LocomotorECS.Entity)));this.entityNamesDict=new(System.Collections.Generic.Dictionary$2(System.String,LocomotorECS.Entity))}},methods:{Add:function(entity){this.entitiesToAdd.add(entity);entity.Name!=null&&this.entityNamesDict.add(entity.Name,entity);this.AddToTagList(entity)},Remove:function(entity){this.entitiesToAdd.remove(entity);this.entitiesToRemove.add(entity);this.RemoveFromTagList(entity)},CommitChanges:function(){var $t,$t1,entity,entity1,i,entity2,isSomethingChanged;if(this.entitiesToRemove.Count>0){$t=Bridge.getEnumerator(this.entitiesToRemove);try{while($t.moveNext())entity=$t.Current,this.RemoveFromTagList(entity),this.entities.remove(entity),entity.Name!=null&&this.entityNamesDict.remove(entity.Name),entity.removeBeforeTagChanged(Bridge.fn.cacheBind(this,this.RemoveFromTagList)),entity.removeAfterTagChanged(Bridge.fn.cacheBind(this,this.AddToTagList))}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}}if(this.entitiesToAdd.Count>0){$t1=Bridge.getEnumerator(this.entitiesToAdd);try{while($t1.moveNext())entity1=$t1.Current,this.AddToTagList(entity1),this.entities.add(entity1),entity1.addBeforeTagChanged(Bridge.fn.cacheBind(this,this.RemoveFromTagList)),entity1.addAfterTagChanged(Bridge.fn.cacheBind(this,this.AddToTagList))}finally{Bridge.is($t1,System.IDisposable)&&$t1.System$IDisposable$Dispose()}}for(i=0;i<this.entities.Count;i=i+1|0)entity2=this.entities.getItem(i),isSomethingChanged=entity2.Components.CommitChanges(),this.entitiesToAdd.contains(entity2)?this.NotifyProcessorsEntityAdded(entity2):this.entitiesToRemove.contains(entity2)?this.NotifyProcessorsEntityRemoved(entity2):isSomethingChanged&&this.NotifyProcessorsEntityChanged(entity2);this.entitiesToRemove.clear();this.entitiesToAdd.clear()},FindEntityByName:function(name){return name==null?null:this.entityNamesDict.containsKey(name)?this.entityNamesDict.get(name):null},FindEntitiesByTag:function(tag){var list={};return this.entityTagsDict.tryGetValue(tag,list)||(list.v=new(System.Collections.Generic.List$1(LocomotorECS.Entity).ctor),this.entityTagsDict.set(tag,list.v)),this.entityTagsDict.get(tag)},AddToTagList:function(entity){if(entity.Tag!==0){var list=this.FindEntitiesByTag(entity.Tag);list.contains(entity)||list.add(entity)}},RemoveFromTagList:function(entity){if(entity.Tag!==0){var list={};this.entityTagsDict.tryGetValue(entity.Tag,list)&&list.v.remove(entity)}},NotifyProcessorsEntityRemoved:function(obj){Bridge.staticEquals(this.EntityRemoved,null)?null:this.EntityRemoved(obj)},NotifyProcessorsEntityAdded:function(obj){Bridge.staticEquals(this.EntityAdded,null)?null:this.EntityAdded(obj)},NotifyProcessorsEntityChanged:function(obj){Bridge.staticEquals(this.EntityChanged,null)?null:this.EntityChanged(obj)}}});Bridge.define("LocomotorECS.EntitySystem",{methods:{OnEntityChanged:function(entity){},OnEntityAdded:function(entity){},OnEntityRemoved:function(entity){},NotifyEntityChanged:function(entity){this.OnEntityChanged(entity)},NotifyEntityAdded:function(entity){this.OnEntityAdded(entity)},NotifyEntityRemoved:function(entity){this.OnEntityRemoved(entity)},Begin:function(){},DoAction:function(gameTime){},End:function(){}}});Bridge.define("LocomotorECS.EntitySystemList",{fields:{processors:null,sortedProcessors:null,dependencies:null,needSorting:!1,UseParallelism:!1},ctors:{init:function(){this.processors=new(System.Collections.Generic.List$1(LocomotorECS.EntitySystem).ctor);this.dependencies=new(System.Collections.Generic.Dictionary$2(LocomotorECS.EntitySystem,System.Collections.Generic.List$1(LocomotorECS.EntitySystem)));this.needSorting=!0;this.UseParallelism=!1},ctor:function(entityList){this.$initialize();entityList.addEntityRemoved(Bridge.fn.cacheBind(this,this.NotifyEntityRemoved));entityList.addEntityAdded(Bridge.fn.cacheBind(this,this.NotifyEntityAdded));entityList.addEntityChanged(Bridge.fn.cacheBind(this,this.NotifyEntityChanged))}},methods:{AddExecutionOrder:function(TBefore,TAfter){var executedBefore=this.Get(TBefore),executedAfter=this.Get(TAfter);this.dependencies.containsKey(executedBefore)||this.dependencies.set(executedBefore,new(System.Collections.Generic.List$1(LocomotorECS.EntitySystem).ctor));this.dependencies.get(executedBefore).add(executedAfter);this.needSorting=!0},RemoveExecutionOrder:function(TBefore,TAfter){var executedBefore=this.Get(TBefore),executedAfter=this.Get(TAfter);this.dependencies.containsKey(executedBefore)&&this.dependencies.get(executedBefore).remove(executedAfter)},Add:function(processor){this.processors.add(processor)},Remove:function(processor){var $t,data;this.processors.remove(processor);this.dependencies.remove(processor);$t=Bridge.getEnumerator(this.dependencies);try{while($t.moveNext())data=$t.Current,data.value.remove(processor)}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}this.needSorting=!0},Get:function(T){for(var processor,i=0;i<this.processors.Count;i=i+1|0)if(processor=this.processors.getItem(i),Bridge.is(processor,T))return Bridge.as(processor,T);return null},NotifyBegin:function(){var $t,$t1,sortedGroup,processor;this.EnsureSorted();$t=Bridge.getEnumerator(this.sortedProcessors,System.Linq.Grouping$2);try{while($t.moveNext()){sortedGroup=$t.Current;$t1=Bridge.getEnumerator(sortedGroup);try{while($t1.moveNext())processor=$t1.Current,processor.Begin()}finally{Bridge.is($t1,System.IDisposable)&&$t1.System$IDisposable$Dispose()}}}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}},NotifyDoAction:function(gameTime){var $t,$t1,sortedGroup,processor;this.EnsureSorted();$t=Bridge.getEnumerator(this.sortedProcessors,System.Linq.Grouping$2);try{while($t.moveNext()){sortedGroup=$t.Current;$t1=Bridge.getEnumerator(sortedGroup);try{while($t1.moveNext())processor=$t1.Current,processor.DoAction(gameTime)}finally{Bridge.is($t1,System.IDisposable)&&$t1.System$IDisposable$Dispose()}}}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}},NotifyEnd:function(){var $t,$t1,sortedGroup,processor;this.EnsureSorted();$t=Bridge.getEnumerator(this.sortedProcessors,System.Linq.Grouping$2);try{while($t.moveNext()){sortedGroup=$t.Current;$t1=Bridge.getEnumerator(sortedGroup);try{while($t1.moveNext())processor=$t1.Current,processor.End()}finally{Bridge.is($t1,System.IDisposable)&&$t1.System$IDisposable$Dispose()}}}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}},EnsureSorted:function(){this.needSorting&&(this.needSorting=!1,this.sortedProcessors=LocomotorECS.Utils.DfsSort.Sort(LocomotorECS.EntitySystem,this.processors,this.dependencies))},NotifyEntityChanged:function(entity){for(var i=0;i<this.processors.Count;i=i+1|0)this.processors.getItem(i).NotifyEntityChanged(entity)},NotifyEntityAdded:function(entity){for(var i=0;i<this.processors.Count;i=i+1|0)this.processors.getItem(i).NotifyEntityAdded(entity)},NotifyEntityRemoved:function(entity){for(var i=0;i<this.processors.Count;i=i+1|0)this.processors.getItem(i).NotifyEntityRemoved(entity)}}});Bridge.define("LocomotorECS.Matching.BitSet",{statics:{fields:{LongMask:0},ctors:{init:function(){this.LongMask=63}}},fields:{bits:null},props:{Length:{get:function(){for(var b,len,i=this.bits.length-1|0;i>=0&&this.bits[System.Array.index(i,this.bits)].equals(System.Int64(0));i=i-1|0);if(i<0)return 0;for(b=this.bits[System.Array.index(i,this.bits)],len=Bridge.Int.mul(i+1|0,64);b.gte(System.Int64(0));)len=len-1|0,b=b.shl(1);return len}},Size:{get:function(){return Bridge.Int.mul(this.bits.length,64)}}},ctors:{ctor:function(){LocomotorECS.Matching.BitSet.$ctor1.call(this,64)},$ctor1:function(nbits){this.$initialize();var nbitslen=nbits>>>0>>>6;(nbits&LocomotorECS.Matching.BitSet.LongMask)!=0&&(nbitslen=nbitslen+1>>>0);this.bits=System.Array.init(nbitslen,System.Int64(0),System.Int64)}},methods:{And:function(bs){for(var max=Math.min(this.bits.length,bs.bits.length),i=0;i<max;i=i+1|0)this.bits[System.Array.index(i,this.bits)]=this.bits[System.Array.index(i,this.bits)].and(bs.bits[System.Array.index(i,bs.bits)]);while(i<this.bits.length)this.bits[System.Array.index(Bridge.identity(i,i=i+1|0),this.bits)]=System.Int64(0)},AndNot:function(bs){for(var i=Math.min(this.bits.length,bs.bits.length);(i=i-1|0)>=0;)this.bits[System.Array.index(i,this.bits)]=this.bits[System.Array.index(i,this.bits)].and(bs.bits[System.Array.index(i,bs.bits)].not())},Cardinality:function(){for(var a,b,card=0,i=this.bits.length-1|0;i>=0;i=i-1|0)if(a=this.bits[System.Array.index(i,this.bits)],!a.equals(System.Int64(0))){if(a.equals(System.Int64(-1))){card=card+64>>>0;continue}a=a.shr(1).and(System.Int64([1431655765,1431655765])).add(a.and(System.Int64([1431655765,1431655765])));a=a.shr(2).and(System.Int64([858993459,858993459])).add(a.and(System.Int64([858993459,858993459])));b=System.Int64.clipu32(a.shr(32).add(a));b=((b>>>4&252645135)>>>0)+((b&252645135)>>>0)>>>0;b=((b>>>8&16711935)>>>0)+((b&16711935)>>>0)>>>0;card=card+(((b>>>16&65535)>>>0)+((b&65535)>>>0)>>>0)>>>0}return card|0},Clear:function(){for(var i=0;i<this.bits.length;i=i+1|0)this.bits[System.Array.index(i,this.bits)]=System.Int64(0)},Clear$1:function(pos){var offset=pos>>6;this.Ensure(offset);this.bits[System.Array.index(offset,this.bits)]=this.bits[System.Array.index(offset,this.bits)].and(System.Int64(1).shl(pos).not())},Clear$2:function(from,to){var loOffset,hiOffset,i;if(from<0||from>to)throw new System.ArgumentOutOfRangeException.ctor;if(from!==to){if(loOffset=from>>>0>>>6,hiOffset=to>>>0>>>6,this.Ensure(hiOffset|0),loOffset===hiOffset){this.bits[System.Array.index(hiOffset,this.bits)]=this.bits[System.Array.index(hiOffset,this.bits)].and(System.Int64(1).shl(from).sub(System.Int64(1)).or(System.Int64(-1).shl(to)));return}for(this.bits[System.Array.index(loOffset,this.bits)]=this.bits[System.Array.index(loOffset,this.bits)].and(System.Int64(1).shl(from).sub(System.Int64(1))),this.bits[System.Array.index(hiOffset,this.bits)]=this.bits[System.Array.index(hiOffset,this.bits)].and(System.Int64(-1).shl(to)),i=(loOffset|0)+1|0;System.Int64(i).lt(System.Int64(hiOffset));i=i+1|0)this.bits[System.Array.index(i,this.bits)]=System.Int64(0)}},Clone:function(){try{var bs=new LocomotorECS.Matching.BitSet.ctor;return bs.bits=Bridge.cast(System.Array.clone(this.bits),System.Array.type(System.Int64)),bs}catch($e1){return $e1=System.Exception.create($e1),null}},Flip:function(index){var offset=index>>6;this.Ensure(offset);this.bits[System.Array.index(offset,this.bits)]=this.bits[System.Array.index(offset,this.bits)].xor(System.Int64(1).shl(index))},Flip$1:function(from,to){var loOffset,hiOffset,i;if(from<0||from>to)throw new System.ArgumentOutOfRangeException.ctor;if(from!==to){if(loOffset=from>>>0>>>6,hiOffset=to>>>0>>>6,this.Ensure(hiOffset|0),loOffset===hiOffset){this.bits[System.Array.index(hiOffset,this.bits)]=this.bits[System.Array.index(hiOffset,this.bits)].xor(System.Int64(-1).shl(from).and(System.Int64(1).shl(to).sub(System.Int64(1))));return}for(this.bits[System.Array.index(loOffset,this.bits)]=this.bits[System.Array.index(loOffset,this.bits)].xor(System.Int64(-1).shl(from)),this.bits[System.Array.index(hiOffset,this.bits)]=this.bits[System.Array.index(hiOffset,this.bits)].xor(System.Int64(1).shl(to).sub(System.Int64(1))),i=(loOffset|0)+1|0;System.Int64(i).lt(System.Int64(hiOffset));i=i+1|0)this.bits[System.Array.index(i,this.bits)]=this.bits[System.Array.index(i,this.bits)].xor(System.Int64(-1))}},Get$1:function(pos){var offset=pos>>6;return offset>=this.bits.length?!1:this.bits[System.Array.index(offset,this.bits)].and(System.Int64(1).shl(pos)).ne(System.Int64(0))},Get:function(from,to){var $t,$t1,bs,loOffset,loBit,hiOffset,len,len2,reverse,i;if(from<0||from>to)throw new System.ArgumentOutOfRangeException.ctor;if(bs=new LocomotorECS.Matching.BitSet.$ctor1(to-from|0),loOffset=from>>>0>>>6,System.Int64(loOffset).gte(System.Int64(this.bits.length))||to===from)return bs;if(loBit=from&LocomotorECS.Matching.BitSet.LongMask,hiOffset=to>>>0>>>6,loBit===0)return len=Math.min((hiOffset-loOffset>>>0)+1>>>0,(this.bits.length>>>0)-loOffset>>>0),System.Array.copy(this.bits,loOffset|0,bs.bits,0,len|0),System.Int64(hiOffset).lt(System.Int64(this.bits.length))&&(bs.bits[System.Array.index($t=hiOffset-loOffset>>>0,bs.bits)]=bs.bits[System.Array.index($t,bs.bits)].and(System.Int64(1).shl(to).sub(System.Int64(1)))),bs;for(len2=Math.min(hiOffset,(this.bits.length>>>0)-1>>>0),reverse=64-loBit|0,i=0;loOffset<len2;loOffset=loOffset+1>>>0,i=i+1|0)bs.bits[System.Array.index(i,bs.bits)]=this.bits[System.Array.index(loOffset,this.bits)].shr(loBit).or(this.bits[System.Array.index(loOffset+1>>>0,this.bits)].shl(reverse));return(to&LocomotorECS.Matching.BitSet.LongMask)>loBit&&(bs.bits[System.Array.index(Bridge.identity(i,i=i+1|0),bs.bits)]=this.bits[System.Array.index(loOffset,this.bits)].shr(loBit)),System.Int64(hiOffset).lt(System.Int64(this.bits.length))&&(bs.bits[System.Array.index($t1=i-1|0,bs.bits)]=bs.bits[System.Array.index($t1,bs.bits)].and(System.Int64(1).shl(to-from|0).sub(System.Int64(1)))),bs},Intersects:function(set){for(var i=Math.min(this.bits.length,set.bits.length);(i=i-1|0)>=0;)if(this.bits[System.Array.index(i,this.bits)].and(set.bits[System.Array.index(i,set.bits)]).ne(System.Int64(0)))return!0;return!1},IsEmpty:function(){for(var i=this.bits.length-1|0;i>=0;i=i-1|0)if(this.bits[System.Array.index(i,this.bits)].ne(System.Int64(0)))return!1;return!0},NextClearBit:function(from){for(var offset=from>>6,mask=System.Int64(1).shl(from),h;offset<this.bits.length;){h=this.bits[System.Array.index(offset,this.bits)];do{if(h.and(mask).equals(System.Int64(0)))return from;mask=mask.shl(1);from=from+1|0}while(mask.ne(System.Int64(0)));mask=System.Int64(1);offset=offset+1|0}return from},NextSetBit:function(from){for(var offset=from>>6,mask=System.Int64(1).shl(from),h;offset<this.bits.length;){h=this.bits[System.Array.index(offset,this.bits)];do{if(h.and(mask).ne(System.Int64(0)))return from;mask=mask.shl(1);from=from+1|0}while(mask.ne(System.Int64(0)));mask=System.Int64(1);offset=offset+1|0}return-1},Set:function(pos){var offset=pos>>6;this.Ensure(offset);this.bits[System.Array.index(offset,this.bits)]=this.bits[System.Array.index(offset,this.bits)].or(System.Int64(1).shl(pos))},Set$1:function(index,value){value?this.Set(index):this.Clear$1(index)},Set$2:function(from,to){var loOffset,hiOffset,i;if(from<0||from>to)throw new System.ArgumentOutOfRangeException.ctor;if(from!==to){if(loOffset=from>>>0>>>6,hiOffset=to>>>0>>>6,this.Ensure(hiOffset|0),loOffset===hiOffset){this.bits[System.Array.index(hiOffset,this.bits)]=this.bits[System.Array.index(hiOffset,this.bits)].or(System.Int64(-1).shl(from).and(System.Int64(1).shl(to).sub(System.Int64(1))));return}for(this.bits[System.Array.index(loOffset,this.bits)]=this.bits[System.Array.index(loOffset,this.bits)].or(System.Int64(-1).shl(from)),this.bits[System.Array.index(hiOffset,this.bits)]=this.bits[System.Array.index(hiOffset,this.bits)].or(System.Int64(1).shl(to).sub(System.Int64(1))),i=(loOffset|0)+1|0;System.Int64(i).lt(System.Int64(hiOffset));i=i+1|0)this.bits[System.Array.index(i,this.bits)]=System.Int64(-1)}},Set$3:function(from,to,value){value?this.Set$2(from,to):this.Clear$2(from,to)},Xor:function(bs){this.Ensure(bs.bits.length-1|0);for(var i=bs.bits.length-1|0;i>=0;i=i-1|0)this.bits[System.Array.index(i,this.bits)]=this.bits[System.Array.index(i,this.bits)].xor(bs.bits[System.Array.index(i,bs.bits)])},Or:function(bs){this.Ensure(bs.bits.length-1|0);for(var i=bs.bits.length-1|0;i>=0;i=i-1|0)this.bits[System.Array.index(i,this.bits)]=this.bits[System.Array.index(i,this.bits)].or(bs.bits[System.Array.index(i,bs.bits)])},Ensure:function(lastElt){if(lastElt>=this.bits.length){var nd=System.Array.init(lastElt+1|0,System.Int64(0),System.Int64);System.Array.copy(this.bits,0,nd,0,this.bits.length);this.bits=nd}},ContainsAll:function(other){for(var i=other.bits.length-1|0;i>=0;i=i-1|0)if(this.bits[System.Array.index(i,this.bits)].and(other.bits[System.Array.index(i,other.bits)]).ne(other.bits[System.Array.index(i,other.bits)]))return!1;return!0},getHashCode:function(){for(var h=System.Int64(1234),i=this.bits.length;i>0;)h=h.xor(System.Int64(i).mul(this.bits[System.Array.index(i=i-1|0,this.bits)]));return System.Int64.clip32(h.shr(32).xor(h))},equals:function(obj){var bs,max,i,j,j1;if(!Bridge.referenceEquals(Bridge.getType(obj),LocomotorECS.Matching.BitSet))return!1;for(bs=Bridge.cast(obj,LocomotorECS.Matching.BitSet),max=Math.min(this.bits.length,bs.bits.length),i=0;i<max;i=i+1|0)if(this.bits[System.Array.index(i,this.bits)].ne(bs.bits[System.Array.index(i,bs.bits)]))return!1;for(j=i;j<this.bits.length;j=j+1|0)if(this.bits[System.Array.index(j,this.bits)].ne(System.Int64(0)))return!1;for(j1=i;j1<bs.bits.length;j1=j1+1|0)if(bs.bits[System.Array.index(j1,bs.bits)].ne(System.Int64(0)))return!1;return!0},toString:function(){for(var bit,word,j,r=new System.Text.StringBuilder("{"),first=!0,i=0;i<this.bits.length;i=i+1|0)if(bit=System.Int64(1),word=this.bits[System.Array.index(i,this.bits)],!word.equals(System.Int64(0)))for(j=0;j<64;j=j+1|0)word.and(bit).ne(System.Int64(0))&&(first||r.append(", "),r.append(Bridge.Int.mul(64,i)+j|0),first=!1),bit=bit.shl(1);return r.append("}").toString()}}});Bridge.define("LocomotorECS.Matching.ComponentTypeManager",{statics:{fields:{ComponentTypesMask:null},ctors:{init:function(){this.ComponentTypesMask=new(System.Collections.Generic.Dictionary$2(Function,System.Int32))}},methods:{GetIndexFor:function(type){return LocomotorECS.Matching.ComponentTypeManager.ComponentTypesMask.containsKey(type)||LocomotorECS.Matching.ComponentTypeManager.ComponentTypesMask.set(type,LocomotorECS.Matching.ComponentTypeManager.ComponentTypesMask.count),LocomotorECS.Matching.ComponentTypeManager.ComponentTypesMask.get(type)},GetTypesFromBits:function(bits){return new(Bridge.GeneratorEnumerable$1(Function))(Bridge.fn.bind(this,function(bits){var $step=0,$jumpFromFinally,$returnValue,$t,keyValuePair,$async_e,$enumerator=new(Bridge.GeneratorEnumerator$1(Function))(Bridge.fn.bind(this,function(){try{for(;;)switch($step){case 0:$t=Bridge.getEnumerator(LocomotorECS.Matching.ComponentTypeManager.ComponentTypesMask);$step=1;continue;case 1:if($t.moveNext()){keyValuePair=$t.Current;$step=2;continue}$step=6;continue;case 2:if(bits.Get$1(keyValuePair.value)){$step=3;continue}$step=5;continue;case 3:return $enumerator.current=keyValuePair.key,$step=4,!0;case 4:$step=5;continue;case 5:$step=1;continue;case 6:default:return!1}}catch($async_e1){$async_e=System.Exception.create($async_e1);throw $async_e;}}));return $enumerator},arguments))}}}});Bridge.define("LocomotorECS.Matching.Matcher",{statics:{methods:{Empty:function(){return new LocomotorECS.Matching.Matcher},AppendTypes:function(builder,headerMessage,typeBits){var $t,firstType=!0,type;builder.append(headerMessage);$t=Bridge.getEnumerator(LocomotorECS.Matching.ComponentTypeManager.GetTypesFromBits(typeBits),Function);try{while($t.moveNext())type=$t.Current,firstType||builder.append(", "),builder.append(Bridge.Reflection.getTypeName(type)),firstType=!1}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}builder.appendLine()}}},fields:{allSet:null,exclusionSet:null,oneSet:null},ctors:{init:function(){this.allSet=new LocomotorECS.Matching.BitSet.ctor;this.exclusionSet=new LocomotorECS.Matching.BitSet.ctor;this.oneSet=new LocomotorECS.Matching.BitSet.ctor}},methods:{All:function(types){var $t,type;types===void 0&&(types=[]);$t=Bridge.getEnumerator(types);try{while($t.moveNext())type=$t.Current,this.allSet.Set(LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(type))}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}return this},Exclude:function(types){var $t,type;types===void 0&&(types=[]);$t=Bridge.getEnumerator(types);try{while($t.moveNext())type=$t.Current,this.exclusionSet.Set(LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(type))}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}return this},One:function(types){var $t,type;types===void 0&&(types=[]);$t=Bridge.getEnumerator(types);try{while($t.moveNext())type=$t.Current,this.oneSet.Set(LocomotorECS.Matching.ComponentTypeManager.GetIndexFor(type))}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}return this},IsMatched:function(entity){if(!this.allSet.IsEmpty())for(var i=this.allSet.NextSetBit(0);i>=0;i=this.allSet.NextSetBit(i+1|0))if(!entity.Components.Bits.Get$1(i))return!1;return!this.exclusionSet.IsEmpty()&&this.exclusionSet.Intersects(entity.Components.Bits)?!1:!this.oneSet.IsEmpty()&&!this.oneSet.Intersects(entity.Components.Bits)?!1:!0},toString:function(){var builder=new System.Text.StringBuilder("",1024);return builder.appendLine("Matcher:"),LocomotorECS.Matching.Matcher.AppendTypes(builder," -  Requires the components: ",this.allSet),LocomotorECS.Matching.Matcher.AppendTypes(builder," -  Has none of the components: ",this.exclusionSet),LocomotorECS.Matching.Matcher.AppendTypes(builder," -  Has at least one of the components: ",this.oneSet),builder.toString()}}});Bridge.define("LocomotorECS.Utils.DfsSort",{statics:{methods:{Dfs:function(T,current,edges,result){var $t,dependent;if(result.set(current,0),edges.containsKey(current)){$t=Bridge.getEnumerator(edges.get(current));try{while($t.moveNext()){if(dependent=$t.Current,result.containsKey(dependent)){result.set(current,Math.max(result.get(current),result.get(dependent)+1|0));continue}result.set(current,Math.max(result.get(current),LocomotorECS.Utils.DfsSort.Dfs(T,dependent,edges,result)+1|0))}}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}}return result.get(current)},Sort:function(T,items,edges){var $t,result=new(System.Collections.Generic.Dictionary$2(T,System.Int32)),current;$t=Bridge.getEnumerator(items);try{while($t.moveNext())(current=$t.Current,result.containsKey(current))||LocomotorECS.Utils.DfsSort.Dfs(T,current,edges,result)}finally{Bridge.is($t,System.IDisposable)&&$t.System$IDisposable$Dispose()}return System.Linq.Enumerable.from(System.Linq.Enumerable.from(result).orderByDescending($asm.$.LocomotorECS.Utils.DfsSort.f1)).toLookup($asm.$.LocomotorECS.Utils.DfsSort.f1,$asm.$.LocomotorECS.Utils.DfsSort.f2)}}}});Bridge.ns("LocomotorECS.Utils.DfsSort",$asm.$);Bridge.apply($asm.$.LocomotorECS.Utils.DfsSort,{f1:function(a){return a.value},f2:function(a){return a.key}});Bridge.define("LocomotorECS.MatcherEntitySystem",{inherits:[LocomotorECS.EntitySystem],props:{Matcher:null,MatchedEntities:null},ctors:{init:function(){this.MatchedEntities=new(System.Collections.Generic.List$1(LocomotorECS.Entity).ctor)},ctor:function(){this.$initialize();LocomotorECS.EntitySystem.ctor.call(this);this.Matcher=LocomotorECS.Matching.Matcher.Empty()},$ctor1:function(matcher){this.$initialize();LocomotorECS.EntitySystem.ctor.call(this);this.Matcher=matcher}},methods:{OnEntityChanged:function(entity){var contains=this.MatchedEntities.contains(entity),interest=this.Matcher.IsMatched(entity);interest?contains?this.OnMatchedEntityChanged(entity):(this.MatchedEntities.add(entity),this.OnMatchedEntityAdded(entity)):contains&&(this.MatchedEntities.remove(entity),this.OnMatchedEntityRemoved(entity))},OnEntityAdded:function(entity){var interest=this.Matcher.IsMatched(entity);interest&&(this.MatchedEntities.add(entity),this.OnMatchedEntityAdded(entity))},OnEntityRemoved:function(entity){var interest=this.Matcher.IsMatched(entity);interest&&(this.MatchedEntities.remove(entity),this.OnMatchedEntityRemoved(entity))},OnMatchedEntityAdded:function(entity){},OnMatchedEntityChanged:function(entity){},OnMatchedEntityRemoved:function(entity){}}});Bridge.define("LocomotorECS.EntityProcessingSystem",{inherits:[LocomotorECS.MatcherEntitySystem],fields:{UseParallelism:!1},ctors:{init:function(){this.UseParallelism=!1},ctor:function(matcher){this.$initialize();LocomotorECS.MatcherEntitySystem.$ctor1.call(this,matcher)}},methods:{DoAction:function(gameTime){LocomotorECS.MatcherEntitySystem.prototype.DoAction.call(this,gameTime);for(var i=0;i<this.MatchedEntities.Count;i=i+1|0)this.DoAction$1(this.MatchedEntities.getItem(i),gameTime)},DoAction$1:function(entity,gameTime){}}})});